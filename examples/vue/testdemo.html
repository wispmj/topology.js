<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>测试1</title>
    <script type="text/javascript" src="./lib/fabric.js"></script>
    <script type="text/javascript" src="./lib/state.js"></script>
    <script type="text/javascript" src="./lib//jquery-3.6.1.min.js"></script>
    <style type="text/css">
        .contoller {
            border: 1px solid #eeeeee;
            margin: 10px 50px;
        }
        
        .inctrl {
            margin: 10px;
        }
        
        .txt {
            margin-left: 10px;
            width: 30px;
        }
        
        .btn {
            width: 80px;
        }
    </style>
    <script type="text/javascript">
        var rect1 = {
            x: 200,
            y: 200,
            ex: 300,
            ey: 500,
            width: 100,
            height: 300,
            cx: 250,
            cy: 350,
        };

        var rect2 = {
            x: 400,
            y: 400,
            ex: 500,
            ey: 700,
            width: 100,
            height: 300,
            cx: 450,
            cy: 550,
        };

        var o1 = {
            x: 200,
            y: 200,
        }
        var o2 = {
            x: 300,
            y: 400,
        };

        var origin = {
            x: 0,
            y: 0,
            cx: 0,
            cy: 0
        }

        var group = {
            topleft: o1,
            center: o2,
            x: o1.x,
            y: o1.y,
            cx: o2.x,
            cy: o2.y
        }

        $(document).ready(function() {

            var curTarget = origin;
            origin.state = new CanvasState();

            var stateParent = new CanvasState();
            stateParent.id = "group";
            group.state = stateParent;

            var stateChild1 = new CanvasState();
            stateChild1.id = "child1";
            rect1.state = stateChild1;

            var stateChild2 = new CanvasState();
            stateChild2.id = "child2";
            rect2.state = stateChild2;

            var c = document.getElementById("myCanvas");
            var ctx = c.getContext("2d");

            $(".btn").click(function(e) {
                var btnInfo = e.target.id.substring(3);
                var oper = btnInfo.substr(0, 1);
                var tar = btnInfo.substr(1, 1);

                if (tar == "P") {
                    curTarget = group;
                } else if (tar == "C") {
                    curTarget = rect2;
                }

                switch (oper) {
                    case "T":
                        var tx = parseFloat($(e.target).prev("input").prev("input").val());
                        var ty = parseFloat($(e.target).prev("input").val());
                        translate(curTarget, tx, ty);
                        break;

                    case "R":
                        var angle = parseFloat($(e.target).prev("input").val());
                        rotate(curTarget, angle);
                        break;

                    case "F":
                        var dir = $(e.target).prev("select").val()
                        flip(curTarget, dir);
                        break;

                    case "S":
                        var sx = parseFloat($(e.target).prev("input").prev("input").val());
                        var sy = parseFloat($(e.target).prev("input").val());
                        scale(curTarget, sx, sy);
                        break;
                }


                render();
            });

            function translate(target, tx, ty) {

                var state = target.state;
                console.log(state.id + ",translate==>  tx:" + tx + ",ty:" + ty);

                state.addTranslate(tx, ty);
            }

            function rotate(target, angle) {

                var state = target.state;
                console.log(target.id + ",rotate==>  angle:" + angle);

                state.addTranslate(target.cx, target.cy);
                state.addRotate(angle);
                state.addTranslate(-target.cx, -target.cy);
            }

            function flip(target, flipDir) {

                var state = target.state;
                console.log(state.id + ",flip==>  dir:" + flipDir);

                state.addTranslate(target.cx, target.cy);
                state.addFlip(flipDir);
                state.addTranslate(-target.cx, -target.cy);
            }

            function scale(target, sx, sy) {

                var state = target.state;
                console.log(state.id + ",scale==>  sx:" + sx + ",sy:" + sy);

                state.addTranslate(target.x, target.y);
                state.addScale(sx, sy);
                state.addTranslate(-target.x, -target.y);
            }

            function render() {
                ctx.restore();
                ctx.save();
                ctx.clearRect(0, 0, 10000, 10000);

                //原始图形
                draw1(rect2);

                //画矩形
                drawRect(rect2);

            }

            function drawRect(rect) {
                ctx.beginPath();
                ctx.strokeStyle = "blue";
                rect.state.setContext(ctx);
                ctx.rect(rect.x, rect.y, rect.width, rect.height);
                ctx.stroke();
            }

        });
    </script>
</head>

<body>
    <div>
        <div class="contoller">
            <div id="divChild" class="inctrl">
                <input id="txtTCx" type="text" class="txt" value="100" />
                <input id="txtTCy" type="text" class="txt" value="50" />
                <input id="btnTC" type="button" class="btn" value="子图形平移" />

                <input id="txtRC" type="text" class="txt" value="0" />
                <input id="btnRC" type="button" class="btn" value="子图形旋转" />

                <select>
                  <option value ="x" selected>x轴</option>
                  <option value ="y">y轴</option>
                </select>
                <input id="btnFC" type="button" class="btn" value="子图形翻转" />

                <input id="txtSCx" type="text" class="txt" value="1" />
                <input id="txtSCy" type="text" class="txt" value="1" />
                <input id="btnSC" type="button" class="btn" value="子图形缩放" />
            </div>
            <div id="divParent" class="inctrl" style="display:none ">
                <input id="txtTPx" type="text" class="txt" value="0" />
                <input id="txtTPy" type="text" class="txt" value="0" />
                <input id="btnTP" type="button" class="btn" value="父图形平移" />

                <input id="txtRP" type="text" class="txt" value="0" />
                <input id="btnRP" type="button" class="btn" value="父图形旋转" />

                <select>
                  <option value ="x" selected>x轴</option>
                  <option value ="y">y轴</option>
                </select>
                <input id="btnFP" type="button" class="btn" value="父图形翻转" />

                <input id="txtSPx" type="text" class="txt" value="1" />
                <input id="txtSPy" type="text" class="txt" value="1" />
                <input id="btnSP" type="button" class="btn" value="父图形缩放" />
            </div>
        </div>
    </div>
    <canvas id="myCanvas" width="1800" height="1800" style="border: 1px solid #d3d3d3; margin: 10px 50px">
      您的浏览器不支持 HTML5 canvas 标签。
    </canvas>
    <script>
        var rotateAngle = 30;

        var c = document.getElementById("myCanvas");
        var ctx = c.getContext("2d");

        function draw1(rect) {
            // 红色矩形
            ctx.beginPath();
            ctx.strokeStyle = "blue";
            ctx.rect(rect.x, rect.y, rect.width, rect.height);
            ctx.stroke();

            ctx.beginPath();
            drawPoint(300, 400, "red");
            ctx.stroke();
            //中间线
            ctx.beginPath();
            ctx.strokeStyle = "black";
            ctx.setLineDash([5, 10]);
            ctx.moveTo(0, rect.cy);
            ctx.lineTo(rect.x * 2 + rect.width, rect.cy);
            ctx.moveTo(rect.cx, 0);
            ctx.lineTo(rect.cx, rect.y * 2 + rect.height);
            ctx.stroke();

        }


        //举行rect围绕origin旋转angle
        function draw5(origin, rect, angle) {
            ctx.restore();
            ctx.beginPath();
            ctx.strokeStyle = "blue";

            var state = new CanvasState();
            state.addTranslate(origin.x, origin.y);
            state.addFlip("x");
            state.addFlip("y");
            state.addRotate(angle);
            state.addFlip("x");
            state.addFlip("y");
            // state.addTranslate(rect.cx - origin.x, rect.cy - origin.y);
            state.addTranslate(-origin.x, -origin.y);
            // state.addTranslate(-rect.cx, -rect.cy);

            var matrix = state.toMatrix();
            ctx.setTransform(
                matrix[0],
                matrix[1],
                matrix[2],
                matrix[3],
                matrix[4],
                matrix[5]
            );

            ctx.rect(rect.x, rect.y, rect.width, rect.height);
            ctx.stroke();
        }

        // function rotate(ang, cx, cy, x, y) {
        //     ctx.translate(cx, cy);
        //     ctx.rotate((Math.PI * ang) / 180);
        //     ctx.translate(-cx, -cy);
        // }

        function drawPoint(x, y, c) {
            ctx.strokeStyle = c || "black";
            ctx.fillStyle = c || "black";
            ctx.moveTo(x, y);
            ctx.arc(x, y, 3, 0, Math.PI * 2, true);
            ctx.fill();
        }

        draw1(rect2);

        // draw2(rect2);

        // draw3(rect2);

        // draw4(o2, rect2);
        // draw5(o2, rect2, rotateAngle);

        // function origin_matrix() {
        //     return [1, 0, 0, 1, 0, 0];
        // }
    </script>
</body>

</html>